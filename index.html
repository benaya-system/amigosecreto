<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Amigo Secreto</title>
    <style>
      :root {
        --bg: #ffffff;
        --fg: #000000;
        --border: #000000;
        --btn-blue: #7fd3ff;
        --btn-yellow: #ffe66b;
        --row-bg: #f7f7f7;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: "Comic Sans MS","Baloo 2","Fredoka",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      }

      /* ===== Layout "blindado" ===== */
      .container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header, footer {
        padding: 8px 12px;
        text-align: center;
        border: none;
        box-shadow: none;
        flex-shrink: 0;          /* footer nunca encolhe por cima do main */
      }

      main {
        flex: 1 0 auto;          /* ocupa o espaço central e empurra o footer */
        padding: 16px;
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
        text-align: center;
        position: relative;
        z-index: 2;              /* garante main acima de qualquer bug */
      }

      footer {
        position: relative;
        z-index: 1;
      }

      .header-placeholder, .footer-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border: none;
      }

      .header-placeholder { height: 160px; }

      /* IMPORTANT: overflow hidden evita "área clicável" sobrando */
      .footer-placeholder {
        height: 90px;
        overflow: hidden;
      }

      .header-placeholder img,
      .footer-placeholder img {
        max-width: 100%;
        max-height: 100%;
        height: auto;
        width: auto;
        display: block;
      }

      /* O link do footer só envolve o GIF e não vira um bloco gigante */
      .footer-placeholder a {
        display: inline-block;
        line-height: 0;
        pointer-events: auto;
      }

      h1 { margin: 0 0 8px; font-size: 28px; letter-spacing: 1px; }
      p.descricao { font-size: 14px; margin: 0 0 24px; }

      table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
      thead { display: none; }
      th, td { border: none; padding: 0; font-size: 14px; }

      #participantsBody tr, #sendBody tr { background: var(--row-bg); border-radius: 999px; }
      #participantsBody td, #sendBody td { padding: 6px 10px; text-align: center; vertical-align: middle; }

      input[type="text"] {
        width: 100%;
        max-width: 280px;
        padding: 6px;
        border: 2px solid var(--border);
        border-radius: 999px;
        text-align: center;
        margin: 4px auto;
        display: block;
        font-family: inherit;
      }

      .btn {
        display: inline-block;
        padding: 8px 10px;
        margin: 2px 2px;
        border: 3px solid var(--border);
        background: var(--btn-yellow);
        color: var(--fg);
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 999px;
        box-shadow: 3px 3px 0 #000;
        transition: transform .08s ease, box-shadow .08s ease, filter .08s ease;
      }

      .btn-primary { background: var(--btn-blue); }
      .btn-small { padding: 4px 8px; font-size: 11px; min-width: 52px; }

      .btn:hover { transform: translate(-2px,-2px); box-shadow: 5px 5px 0 #000; filter: brightness(1.05); }
      .btn:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 #000; }
      .btn:disabled { opacity:.5; cursor:not-allowed; filter:none; box-shadow: 3px 3px 0 #000; }

      .linha-botoes {
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        justify-content:center;
        margin-bottom: 24px;
      }

      .hidden { display: none; }

      #status { font-size: 13px; min-height: 18px; margin-bottom: 8px; }
      #resultado { margin-top: 24px; }
      #resultado h2 { margin: 0 0 8px; font-size: 18px; }

      @media (max-width: 768px) {
        main { padding: 12px; }
        h1 { font-size: 24px; }
        .header-placeholder { height: 130px; }
        .footer-placeholder { height: 70px; }
      }

      @media (max-width: 480px) {
        main { padding: 10px; }
        h1 { font-size: 22px; }
        p.descricao { font-size: 13px; }
        .header-placeholder { height: 110px; }
        .footer-placeholder { height: 60px; }
        .linha-botoes { flex-direction: column; align-items: stretch; }
        .btn { width: 100%; }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <div class="header-placeholder">
          <img src="familyguys.png" alt="header" />
        </div>
      </header>

      <main>
        <h1>Amigo Secreto</h1>
        <p class="descricao">
          Digite apenas os nomes, clique em <strong>Sortear</strong> e depois use WA / TG / CP para enviar.
        </p>

        <div id="status"></div>

        <table>
          <tbody id="participantsBody"></tbody>
        </table>

        <div class="linha-botoes">
          <button type="button" class="btn" id="addRowBtn">+ Adicionar pessoa</button>
          <button type="button" class="btn btn-primary" id="sortearBtn">Sortear amigo secreto</button>
        </div>

        <div id="resultado" class="hidden">
          <h2>Envio de links</h2>
          <p style="font-size:13px; margin: 0 0 8px;">
            Botões pequenos lado a lado: <strong>WA</strong> WhatsApp, <strong>TG</strong> Telegram, <strong>CP</strong> copiar mensagem.
          </p>

          <table>
            <tbody id="sendBody"></tbody>
          </table>
        </div>
      </main>

      <footer>
        <div class="footer-placeholder">
          <a href="https://instagram.com/brunopatriots" target="_blank" rel="noreferrer">
            <img src="foot2.gif" alt="footer" />
          </a>
        </div>
      </footer>
    </div>

    <script>
      const APP_URL = 'https://script.google.com/macros/s/AKfycbz2lDkpVnBRLzc72iXHIgvDVLOBXnPLgXN4nIQGUhF-LpqR9XiqztdQ7X_G8eYPKHPJ3g/exec';
      const VIEW_URL = new URL('ver.html', window.location.href).toString().split('?')[0].split('#')[0];

      function adicionarLinha(nome = '') {
        const tbody = document.getElementById('participantsBody');
        const tr = document.createElement('tr');

        const tdNome = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Nome';
        input.value = nome;
        tdNome.appendChild(input);

        const tdAcoes = document.createElement('td');
        const btnX = document.createElement('button');
        btnX.type = 'button';
        btnX.textContent = 'X';
        btnX.className = 'btn btn-small';
        btnX.onclick = () => tbody.removeChild(tr);
        tdAcoes.appendChild(btnX);

        tr.appendChild(tdNome);
        tr.appendChild(tdAcoes);
        tbody.appendChild(tr);
      }

      function coletarParticipantes() {
        const rows = document.querySelectorAll('#participantsBody tr');
        const participants = [];
        rows.forEach(r => {
          const input = r.querySelector('input');
          const name = (input?.value || '').trim();
          if (name) participants.push({ name });
        });
        return participants;
      }

      function mostrarStatus(msg, erro=false) {
        const el = document.getElementById('status');
        el.textContent = msg || '';
        el.style.color = erro ? 'red' : 'black';
      }

      function montarMensagem(name, token) {
        const link = VIEW_URL + '?t=' + encodeURIComponent(token);
        return 'Olá ' + name + ', clique no link abaixo pra saber quem você tirou no amigo secreto:\n' + link;
      }

      function abrirWhatsApp(texto) {
        window.open('https://wa.me/?text=' + encodeURIComponent(texto), '_blank');
      }

      function abrirTelegram(texto, token) {
        const link = VIEW_URL + '?t=' + encodeURIComponent(token);
        const url = 'https://t.me/share/url?url=' + encodeURIComponent(link) + '&text=' + encodeURIComponent(texto);
        window.open(url, '_blank');
      }

      function copiarTexto(texto) {
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(texto)
            .then(() => alert('Mensagem copiada!'))
            .catch(() => window.prompt('Copie a mensagem:', texto));
        } else {
          window.prompt('Copie a mensagem:', texto);
        }
      }

      function preencherEnvio(data) {
        const tbody = document.getElementById('sendBody');
        tbody.innerHTML = '';

        data.forEach(item => {
          const tr = document.createElement('tr');

          const tdNome = document.createElement('td');
          tdNome.textContent = item.name;

          const tdAcoes = document.createElement('td');
          const texto = montarMensagem(item.name, item.token);

          const btnWA = document.createElement('button');
          btnWA.className = 'btn btn-small btn-primary';
          btnWA.textContent = 'WA';
          btnWA.title = 'WhatsApp';
          btnWA.onclick = () => abrirWhatsApp(texto);

          const btnTG = document.createElement('button');
          btnTG.className = 'btn btn-small';
          btnTG.textContent = 'TG';
          btnTG.title = 'Telegram';
          btnTG.onclick = () => abrirTelegram(texto, item.token);

          const btnCP = document.createElement('button');
          btnCP.className = 'btn btn-small';
          btnCP.textContent = 'CP';
          btnCP.title = 'Copiar';
          btnCP.onclick = () => copiarTexto(texto);

          tdAcoes.appendChild(btnWA);
          tdAcoes.appendChild(btnTG);
          tdAcoes.appendChild(btnCP);

          tr.appendChild(tdNome);
          tr.appendChild(tdAcoes);
          tbody.appendChild(tr);
        });

        document.getElementById('resultado').classList.remove('hidden');
      }

      function sortear() {
        const participants = coletarParticipantes();
        if (participants.length < 2) {
          mostrarStatus('Adicione pelo menos 2 nomes.', true);
          return;
        }

        mostrarStatus('Sorteando... aguarde.');
        const btn = document.getElementById('sortearBtn');
        btn.disabled = true;

        const names = participants.map(p => p.name).join('|');
        const phones = new Array(participants.length).fill('').join('|');

        const url = APP_URL + '?mode=sortear&names=' + encodeURIComponent(names) + '&phones=' + encodeURIComponent(phones);

        fetch(url)
          .then(r => r.json())
          .then(resp => {
            btn.disabled = false;
            if (!resp.ok) {
              mostrarStatus('Erro: ' + (resp.error || 'desconhecido'), true);
              return;
            }
            preencherEnvio(resp.data || []);
            mostrarStatus('Sorteio pronto! Agora envie os links.');
          })
          .catch(err => {
            btn.disabled = false;
            mostrarStatus('Erro de conexão: ' + err, true);
          });
      }

      document.addEventListener('DOMContentLoaded', () => {
        adicionarLinha();
        adicionarLinha();
        document.getElementById('addRowBtn').addEventListener('click', () => adicionarLinha());
        document.getElementById('sortearBtn').addEventListener('click', sortear);
      });
    </script>
  </body>
</html>