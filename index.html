<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Amigo Secreto</title>
    <style>
      :root {
        --bg: #ffffff;
        --fg: #000000;
        --border: #000000;
        --btn-blue: #7fd3ff;    /* azul claro cartoon */
        --btn-yellow: #ffe66b;  /* amarelo cartoon  */
      }

      /* Reset e base */
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: "Comic Sans MS", "Baloo 2", "Fredoka",
          system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      /* Layout geral */
      .container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* HEADER e FOOTER */
      header,
      footer {
        padding: 8px 12px;
        text-align: center;
        border: none;
        box-shadow: none;
      }

      .header-placeholder,
      .footer-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        padding: 0;
      }

      .header-placeholder {
        height: 160px;
      }

      .footer-placeholder {
        height: 90px;
      }

      .header-placeholder img,
      .footer-placeholder img {
        max-width: 100%;
        max-height: 100%;
        height: auto;
        width: auto;
        display: block;
      }

      /* Conte√∫do principal */
      main {
        padding: 16px;
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        margin-bottom: 8px;
        font-size: 28px;
        letter-spacing: 1px;
      }

      p.descricao {
        text-align: center;
        font-size: 14px;
        margin-bottom: 24px;
      }

      /* Tabelas */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 12px;
      }

      th,
      td {
        border: 1px solid var(--border);
        padding: 8px;
        font-size: 14px;
      }

      th {
        background: #f5f5f5;
      }

      /* Inputs */
      input[type="text"] {
        width: 100%;
        padding: 6px;
        border: 2px solid var(--border);
        background: var(--bg);
        color: var(--fg);
        font-family: inherit;
        font-size: 14px;
        border-radius: 6px;
      }

      /* Bot√µes estilo cartoon */
      .btn {
        display: inline-block;
        padding: 10px 16px;
        margin: 4px 2px;
        border: 3px solid var(--border);
        background: var(--btn-yellow);
        color: var(--fg);
        font-family: inherit;
        font-size: 13px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-radius: 999px;
        box-shadow: 3px 3px 0 #000000;
        transition: transform 0.08s ease,
          box-shadow 0.08s ease,
          filter 0.08s ease;
      }

      .btn-primary {
        background: var(--btn-blue);
      }

      .btn-small {
        padding: 4px 10px;
        font-size: 12px;
      }

      .btn:hover {
        transform: translate(-2px, -2px);
        box-shadow: 5px 5px 0 #000000;
        filter: brightness(1.05);
      }

      .btn:active {
        transform: translate(1px, 1px);
        box-shadow: 1px 1px 0 #000000;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        filter: none;
        box-shadow: 3px 3px 0 #000000;
      }

      .linha-botoes {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 24px;
      }

      .hidden {
        display: none;
      }

      #status {
        font-size: 13px;
        min-height: 18px;
        margin-bottom: 8px;
      }

      /* Resultado do sorteio */
      #resultado {
        margin-top: 24px;
      }

      #resultado h2 {
        margin-bottom: 8px;
        font-size: 18px;
        text-align: center;
      }

      /* Se√ß√£o de visualiza√ß√£o (quem recebeu o link) */
      #viewSection {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 50vh;
      }

      .view-card {
        border: 3px solid #000000;
        padding: 24px 32px;
        max-width: 520px;
        width: calc(100% - 32px);
        margin: 0 auto;
        text-align: center;
        border-radius: 16px;
        box-shadow: 4px 4px 0 #000000;
      }

      .view-card h1 {
        margin-top: 0;
        margin-bottom: 16px;
        font-size: 24px;
      }

      .view-card p {
        margin: 8px 0;
        font-size: 15px;
      }

      .view-nome {
        font-size: 22px;
        font-weight: bold;
        margin-top: 16px;
        margin-bottom: 8px;
      }

      .observacao {
        margin-top: 16px;
        font-size: 12px;
        color: #555555;
      }

      /* Responsivo */
      @media (max-width: 768px) {
        main {
          padding: 12px;
        }

        h1 {
          font-size: 24px;
        }

        th,
        td {
          font-size: 13px;
          padding: 6px;
        }

        .view-card {
          padding: 20px;
          margin: 0 10px;
        }

        .header-placeholder {
          height: 130px;
        }

        .footer-placeholder {
          height: 70px;
        }

        .btn {
          width: auto;
        }
      }

      @media (max-width: 480px) {
        .view-card {
          padding: 20px 16px;
          width: calc(100% - 24px);
        }

        h1 {
          font-size: 22px;
        }

        .view-nome {
          font-size: 22px;
        }

        main {
          padding: 10px;
        }

        p.descricao {
          font-size: 13px;
        }

        table {
          display: block;
          width: 100%;
          overflow-x: auto;
        }

        .linha-botoes {
          flex-direction: column;
          align-items: stretch;
        }

        .btn {
          width: 100%;
          text-align: center;
        }

        .header-placeholder {
          height: 110px;
        }

        .footer-placeholder {
          height: 60px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="header-placeholder">
          <img src="familyguys.png">
        </div>
      </header>

      <main>
        <!-- Se√ß√£o ADMIN (cadastro e sorteio) -->
        <div id="adminSection">
          <h1>Amigo Secreto</h1>
          <p class="descricao">
            Digite apenas os nomes, clique em "Sortear amigo secreto" e depois
            use os bot√µes para enviar o link por WhatsApp, Telegram ou copiar a mensagem.
          </p>

          <div id="status"></div>

          <table id="participantsTable">
            <thead>
              <tr>
                <th>Nome</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="participantsBody">
              <!-- Linhas adicionadas via JavaScript -->
            </tbody>
          </table>

          <div class="linha-botoes">
            <button type="button" class="btn" id="addRowBtn">
              + Adicionar pessoa
            </button>
            <button type="button" class="btn btn-primary" id="sortearBtn">
              Sortear amigo secreto
            </button>
          </div>

          <div id="resultado" class="hidden">
            <h2>Envio de links</h2>
            <p style="font-size: 13px; text-align: center; margin-bottom: 8px;">
              Use os bot√µes ao lado de cada nome para abrir WhatsApp, Telegram
              ou copiar a mensagem com o link.
            </p>
            <table>
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="sendBody">
                <!-- Preenchido ap√≥s o sorteio -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Se√ß√£o VISUALIZA√á√ÉO (quem recebeu o link) -->
        <div id="viewSection" class="hidden">
          <div class="view-card">
            <h1>Amigo Secreto</h1>
            <p id="viewStatus">Carregando seu amigo secreto...</p>

            <div id="viewContent" class="hidden">
              <p>Ol√°, <strong id="viewGiver"></strong>!</p>
              <p>O seu amigo secreto √©:</p>
              <p class="view-nome" id="viewName"></p>
              <p class="observacao">
                Guarde este nome em segredo üòâ<br>
                (Se voc√™ recebeu este link, ele √© s√≥ seu.)
              </p>
            </div>
          </div>
        </div>
      </main>

      <footer>
        <div class="footer-placeholder">
          <a href="https://instagram.com/brunopatriots" target="_blank">
            <img src="foot2.gif" alt="Reset">
          </a>
        </div>
      </footer>
    </div>

    <script>
      // URL do Apps Script (sua API)
      const APP_URL =
        'https://script.google.com/macros/s/AKfycbxZYHhMONby1iKjlAWV48EL9WD8W1Zz3vAkR2YYOBl_QNnIh3BZqAPV7qi_sREkH9C-Nw/exec';

      // URL da pr√≥pria p√°gina (pra gerar o link)
      const SITE_URL = window.location.origin + window.location.pathname;

      let ultimoResultado = [];

      function adicionarLinha(nome = '') {
        const tbody = document.getElementById('participantsBody');
        const tr = document.createElement('tr');

        const tdNome = document.createElement('td');
        const inputNome = document.createElement('input');
        inputNome.type = 'text';
        inputNome.placeholder = 'Nome';
        inputNome.value = nome;
        tdNome.appendChild(inputNome);

        const tdAcoes = document.createElement('td');
        const btnRemover = document.createElement('button');
        btnRemover.type = 'button';
        btnRemover.textContent = 'x';
        btnRemover.className = 'btn btn-small';
        btnRemover.onclick = function () {
          tbody.removeChild(tr);
        };
        tdAcoes.appendChild(btnRemover);

        tr.appendChild(tdNome);
        tr.appendChild(tdAcoes);

        tbody.appendChild(tr);
      }

      function coletarParticipantes() {
        const linhas = document.querySelectorAll('#participantsBody tr');
        const participantes = [];

        linhas.forEach((linha) => {
          const inputNome = linha.querySelector('td:nth-child(1) input');
          if (!inputNome) return;
          const nome = inputNome.value.trim();
          if (nome) {
            participantes.push({ name: nome });
          }
        });

        return participantes;
      }

      function mostrarStatus(msg, erro = false) {
        const el = document.getElementById('status');
        el.textContent = msg || '';
        el.style.color = erro ? 'red' : 'black';
      }

      function sortear() {
        const participantes = coletarParticipantes();
        if (participantes.length < 2) {
          mostrarStatus(
            'Adicione pelo menos 2 participantes com nome.',
            true
          );
          return;
        }

        mostrarStatus('Sorteando... aguarde.');
        document.getElementById('sortearBtn').disabled = true;

        const names = participantes.map((p) => p.name).join('|');
        // Phones vazios s√≥ pra manter o formato esperado pela API
        const phones = new Array(participantes.length).fill('').join('|');

        const url =
          APP_URL +
          '?mode=sortear&names=' +
          encodeURIComponent(names) +
          '&phones=' +
          encodeURIComponent(phones);

        fetch(url)
          .then((r) => r.json())
          .then((data) => {
            document.getElementById('sortearBtn').disabled = false;
            if (!data.ok) {
              mostrarStatus(
                'Erro ao sortear: ' + (data.error || 'desconhecido'),
                true
              );
              return;
            }
            ultimoResultado = data.data || [];
            if (!ultimoResultado.length) {
              mostrarStatus(
                'Sorteio n√£o retornou dados. Tente novamente.',
                true
              );
              return;
            }
            preencherTabelaEnvio(ultimoResultado);
            mostrarStatus(
              'Sorteio realizado com sucesso! Agora envie os links.',
              false
            );
          })
          .catch((err) => {
            document.getElementById('sortearBtn').disabled = false;
            mostrarStatus(
              'Erro ao conectar com o servidor: ' + err,
              true
            );
          });
      }

      function preencherTabelaEnvio(dados) {
        const divResultado = document.getElementById('resultado');
        const tbody = document.getElementById('sendBody');
        tbody.innerHTML = '';

        dados.forEach((item) => {
          const tr = document.createElement('tr');

          const tdNome = document.createElement('td');
          tdNome.textContent = item.name;

          const tdAcoes = document.createElement('td');

          const btnWA = document.createElement('button');
          btnWA.type = 'button';
          btnWA.textContent = 'WhatsApp';
          btnWA.className = 'btn btn-small btn-primary';
          btnWA.onclick = function () {
            enviarCodigoWhatsApp(item);
          };

          const btnTG = document.createElement('button');
          btnTG.type = 'button';
          btnTG.textContent = 'Telegram';
          btnTG.className = 'btn btn-small';
          btnTG.onclick = function () {
            enviarCodigoTelegram(item);
          };

          const btnCopy = document.createElement('button');
          btnCopy.type = 'button';
          btnCopy.textContent = 'Copiar link';
          btnCopy.className = 'btn btn-small';
          btnCopy.onclick = function () {
            copiarMensagem(item);
          };

          tdAcoes.appendChild(btnWA);
          tdAcoes.appendChild(btnTG);
          tdAcoes.appendChild(btnCopy);

          tr.appendChild(tdNome);
          tr.appendChild(tdAcoes);

          tbody.appendChild(tr);
        });

        divResultado.classList.remove('hidden');
      }

      function montarMensagem(item) {
        const link = SITE_URL + '?t=' + encodeURIComponent(item.token);
        return (
          'Ol√° ' +
          item.name +
          ', clique no link abaixo pra saber quem voc√™ tirou no amigo secreto:\n' +
          link
        );
      }

      function enviarCodigoWhatsApp(item) {
        const mensagem = montarMensagem(item);
        const url =
          'https://wa.me/?text=' + encodeURIComponent(mensagem);
        window.open(url, '_blank');
      }

      function enviarCodigoTelegram(item) {
        const link = SITE_URL + '?t=' + encodeURIComponent(item.token);
        const texto =
          'Ol√° ' +
          item.name +
          ', clique no link abaixo pra saber quem voc√™ tirou no amigo secreto:';
        const url =
          'https://t.me/share/url?url=' +
          encodeURIComponent(link) +
          '&text=' +
          encodeURIComponent(texto);
        window.open(url, '_blank');
      }

      function copiarMensagem(item) {
        const mensagem = montarMensagem(item);

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(mensagem)
            .then(() => {
              alert('Mensagem copiada para a √°rea de transfer√™ncia!');
            })
            .catch(() => {
              fallbackPrompt(mensagem);
            });
        } else {
          fallbackPrompt(mensagem);
        }
      }

      function fallbackPrompt(texto) {
        window.prompt(
          'Copie a mensagem abaixo (Ctrl+C / Command+C):',
          texto
        );
      }

      // ====== MODO VISUALIZA√á√ÉO (quem recebeu o link) ======

      function entrarModoVisualizacao(token) {
        document
          .getElementById('adminSection')
          .classList.add('hidden');
        document
          .getElementById('viewSection')
          .classList.remove('hidden');

        const statusEl = document.getElementById('viewStatus');
        const contentEl = document.getElementById('viewContent');
        const giverEl = document.getElementById('viewGiver');
        const nameEl = document.getElementById('viewName');

        statusEl.textContent = 'Carregando seu amigo secreto...';
        contentEl.classList.add('hidden');

        const url = APP_URL + '?t=' + encodeURIComponent(token);

        fetch(url)
          .then((r) => r.json())
          .then((data) => {
            if (!data.ok) {
              statusEl.textContent =
                'Ops! N√£o encontramos um amigo secreto para este link.';
              return;
            }
            statusEl.textContent = '';
            giverEl.textContent = data.giverName || '';
            nameEl.textContent = data.friendName || '???';
            contentEl.classList.remove('hidden');
          })
          .catch(() => {
            statusEl.textContent =
              'Erro ao carregar informa√ß√µes. Tente novamente mais tarde.';
          });
      }

      function entrarModoAdmin() {
        document
          .getElementById('adminSection')
          .classList.remove('hidden');
        document
          .getElementById('viewSection')
          .classList.add('hidden');

        // Come√ßa com duas linhas
        adicionarLinha();
        adicionarLinha();
      }

      // ====== Inicializa√ß√£o ======
      document.addEventListener('DOMContentLoaded', function () {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('t');

        if (token) {
          entrarModoVisualizacao(token);
        } else {
          entrarModoAdmin();
        }

        const addBtn = document.getElementById('addRowBtn');
        if (addBtn) {
          addBtn.addEventListener('click', function () {
            adicionarLinha();
          });
        }
        const sortearBtn = document.getElementById('sortearBtn');
        if (sortearBtn) {
          sortearBtn.addEventListener('click', sortear);
        }
      });
    </script>
  </body>
</html>