<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Amigo Secreto</title>

    <style>
      :root{
        --bg:#fff; --fg:#000; --border:#000;
        --btn-blue:#7fd3ff; --btn-yellow:#ffe66b;
      }
      *{ box-sizing:border-box; }
      body{
        margin:0;
        background:var(--bg);
        color:var(--fg);
        font-family:"Comic Sans MS","Baloo 2","Fredoka",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      }

      /* Layout blindado */
      .container{
        min-height:100vh;
        display:flex;
        flex-direction:column;
      }
      header, footer{
        padding:8px 12px;
        text-align:center;
        border:none;
        box-shadow:none;
        flex-shrink:0;
      }
      main{
        flex:1 0 auto;
        padding:16px;
        max-width:800px;
        width:100%;
        margin:0 auto;
        text-align:center;
        position:relative;
        z-index:2;
      }

      .header-placeholder,.footer-placeholder{
        display:flex;
        align-items:center;
        justify-content:center;
        padding:0;
      }
      .header-placeholder{ height:160px; }
      .footer-placeholder{ height:90px; overflow:hidden; }

      .header-placeholder img,
      .footer-placeholder img{
        max-width:100%;
        max-height:100%;
        height:auto;
        width:auto;
        display:block;
      }

      /* CR√çTICO: footer n√£o captura clique, s√≥ o <a> captura */
      footer{ pointer-events:none; }
      .footer-placeholder a{
        pointer-events:auto;
        display:inline-block;
        line-height:0;
      }

      .card{
        border:3px solid #000;
        padding:22px 18px;
        max-width:520px;
        width:calc(100% - 24px);
        margin:0 auto;
        border-radius:16px;
        box-shadow:4px 4px 0 #000;
      }

      h1{ margin:0 0 10px; font-size:24px; letter-spacing:1px; }
      p{ margin:8px 0; font-size:15px; }

      .big-warning{
        font-weight:900;
        font-size:14px;
        margin:10px 0 14px;
      }
      .who{
        font-size:20px;
        font-weight:900;
        margin:6px 0 14px;
      }

      .btn{
        display:inline-block;
        padding:10px 16px;
        margin:6px 2px;
        border:3px solid var(--border);
        background:var(--btn-yellow);
        color:var(--fg);
        font-family:inherit;
        font-size:13px;
        cursor:pointer;
        text-transform:uppercase;
        letter-spacing:.5px;
        border-radius:999px;
        box-shadow:3px 3px 0 #000;
        transition:transform .08s ease, box-shadow .08s ease, filter .08s ease;
        position:relative;
        z-index:3; /* extra: bot√£o sempre por cima */
      }
      .btn-primary{ background:var(--btn-blue); }
      .btn:hover{ transform:translate(-2px,-2px); box-shadow:5px 5px 0 #000; filter:brightness(1.05); }
      .btn:active{ transform:translate(1px,1px); box-shadow:1px 1px 0 #000; }
      .btn:disabled{ opacity:.55; cursor:not-allowed; filter:none; }

      .hidden{ display:none; }
      #status{ min-height:18px; font-size:13px; }

      .nome{
        font-size:24px;
        font-weight:900;
        margin:14px 0 6px;
      }
      .observacao{
        margin-top:12px;
        font-size:12px;
        color:#555;
      }

      /* Presentinho */
      .gift{
        width:110px; height:110px;
        margin:14px auto 8px;
        position:relative;
      }
      .gift-box{
        position:absolute;
        left:10px; right:10px; bottom:10px; top:38px;
        border:3px solid #000;
        border-radius:12px;
        background:#ffe66b;
        box-shadow:4px 4px 0 #000;
      }
      .gift-lid{
        position:absolute;
        left:6px; right:6px; top:18px; height:34px;
        border:3px solid #000;
        border-radius:12px;
        background:#7fd3ff;
        transform-origin:left center;
        transition:transform .35s ease;
        box-shadow:4px 4px 0 #000;
      }
      .gift-ribbon{
        position:absolute;
        left:50%; top:18px; bottom:10px;
        width:10px; transform:translateX(-50%);
        background:#fff;
        border:3px solid #000;
        border-radius:999px;
      }
      .gift.open .gift-lid{
        transform:rotate(-35deg) translate(-8px,-8px);
      }

      @media (max-width:768px){
        main{ padding:12px; }
        .header-placeholder{ height:130px; }
        .footer-placeholder{ height:70px; }
      }
      @media (max-width:480px){
        main{ padding:10px; }
        .header-placeholder{ height:110px; }
        .footer-placeholder{ height:60px; }
        .card{ width:calc(100% - 18px); padding:18px 14px; }
        h1{ font-size:22px; }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <div class="header-placeholder">
          <img src="familyguys.png" alt="header" />
        </div>
      </header>

      <main>
        <div class="card">
          <h1>Amigo Secreto</h1>

          <p class="big-warning">
            ‚ö†Ô∏è ATEN√á√ÉO: o nome s√≥ poder√° ser revelado neste dispositivo.<br/>
            N√£o abra se voc√™ n√£o for a pessoa indicada abaixo.
          </p>

          <p id="status">Carregando...</p>

          <div id="mainOk" class="hidden">
            <p>Este link pertence a:</p>
            <p class="who" id="giverName">‚Äî</p>

            <div class="gift" id="giftBox">
              <div class="gift-lid"></div>
              <div class="gift-box"></div>
              <div class="gift-ribbon"></div>
            </div>

            <button class="btn btn-primary" id="revealBtn" type="button">
              Revelar meu amigo secreto üéÅ
            </button>

            <div id="result" class="hidden">
              <p>O seu amigo secreto √©:</p>
              <p class="nome" id="friendName"></p>
              <p class="observacao">Guarde este nome em segredo üòâ</p>
            </div>
          </div>
        </div>
      </main>

      <footer>
        <div class="footer-placeholder">
          <a href="https://instagram.com/brunopatriots" target="_blank" rel="noreferrer">
            <img src="foot2.gif" alt="footer" />
          </a>
        </div>
      </footer>
    </div>

    <script>
      // COLE AQUI seu Web App (Apps Script /exec)
      const APP_URL = 'https://script.google.com/macros/s/AKfycbz2lDkpVnBRLzc72iXHIgvDVLOBXnPLgXN4nIQGUhF-LpqR9XiqztdQ7X_G8eYPKHPJ3g/exec';

      function getToken(){
        return (new URLSearchParams(window.location.search).get('t') || '').trim();
      }

      function getDeviceKey(){
        const k = 'as_device_key_v1';
        let key = localStorage.getItem(k);
        if (!key){
          try{
            const arr = new Uint8Array(24);
            crypto.getRandomValues(arr);
            key = Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
          }catch(e){
            key = String(Math.random()).slice(2) + String(Date.now());
          }
          localStorage.setItem(k, key);
        }
        return key;
      }

      async function sha256Hex(str){
        try{
          const enc = new TextEncoder().encode(str);
          const buf = await crypto.subtle.digest('SHA-256', enc);
          return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }catch(e){
          return 'h_' + btoa(unescape(encodeURIComponent(str))).slice(0, 40);
        }
      }

      function setStatus(msg, err=false){
        const el = document.getElementById('status');
        el.textContent = msg || '';
        el.style.color = err ? 'red' : 'black';
      }

      async function init(){
        const token = getToken();
        if (!token){
          setStatus('Link inv√°lido (sem token).', true);
          return;
        }

        const deviceHash = await sha256Hex(getDeviceKey());

        // PEEK n√£o trava (evita falso positivo por preview)
        const peekUrl = APP_URL + '?mode=peek&t=' + encodeURIComponent(token) + '&d=' + encodeURIComponent(deviceHash);

        try{
          const peek = await fetch(peekUrl).then(r=>r.json());

          if (!peek.ok){
            setStatus('Ops! N√£o encontramos um amigo secreto para este link.', true);
            return;
          }

          document.getElementById('giverName').textContent = peek.giverName || '‚Äî';
          document.getElementById('mainOk').classList.remove('hidden');

          if (peek.status === 'locked'){
            setStatus('‚ö†Ô∏è Esse link j√° foi visualizado em outro dispositivo. Converse com o organizador.', true);
            document.getElementById('revealBtn').disabled = true;
            return;
          }

          setStatus('');

          const revealBtn = document.getElementById('revealBtn');
          const giftBox = document.getElementById('giftBox');
          const result = document.getElementById('result');
          const friendNameEl = document.getElementById('friendName');

          revealBtn.onclick = async () => {
            revealBtn.disabled = true;
            revealBtn.textContent = 'Abrindo...';

            try{
              // 1) CLAIM (s√≥ no clique!)
              const claimUrl = APP_URL + '?mode=claim&t=' + encodeURIComponent(token) + '&d=' + encodeURIComponent(deviceHash);
              const claim = await fetch(claimUrl).then(r=>r.json());

              if (!claim.ok){
                setStatus('‚ö†Ô∏è Esse link j√° foi visualizado em outro dispositivo. Converse com o organizador.', true);
                revealBtn.textContent = 'Revelar meu amigo secreto üéÅ';
                revealBtn.disabled = true;
                return;
              }

              // 2) REVEAL
              const revealUrl = APP_URL + '?mode=reveal&t=' + encodeURIComponent(token) + '&d=' + encodeURIComponent(deviceHash);
              const rev = await fetch(revealUrl).then(r=>r.json());

              if (!rev.ok){
                setStatus('‚ö†Ô∏è Esse link j√° foi visualizado em outro dispositivo. Converse com o organizador.', true);
                revealBtn.textContent = 'Revelar meu amigo secreto üéÅ';
                revealBtn.disabled = true;
                return;
              }

              setStatus('');
              giftBox.classList.add('open');
              friendNameEl.textContent = rev.friendName || '???';
              result.classList.remove('hidden');
              revealBtn.textContent = 'Revelado ‚úÖ';
            }catch(e){
              setStatus('Erro ao revelar. Tente novamente mais tarde.', true);
              revealBtn.textContent = 'Revelar meu amigo secreto üéÅ';
              revealBtn.disabled = false;
            }
          };

        }catch(e){
          setStatus('Erro ao carregar. Tente novamente mais tarde.', true);
        }
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
